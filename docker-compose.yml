version: '3.8'

services:
  # 1. Node.js ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒ“ã‚¹
  app:
    # ğŸš¨ imageã¾ãŸã¯buildã§Node.jsã‚’æŒ‡å®š
    build:
      context: ./server # å‚ç…§ã™ã‚‹ãƒ•ã‚©ãƒ«ãƒ€
    container_name: keep-info-app
    ports:
      - "8080:8080" # ãƒ›ã‚¹ãƒˆ:ã‚³ãƒ³ãƒ†ãƒŠ ãƒãƒ¼ãƒˆãƒãƒƒãƒ”ãƒ³ã‚°
    volumes:
      - ./server:/usr/src/app
      - /usr/src/app/node_modules
    environment:
      # DBæ¥ç¶šæƒ…å ± (NestJSãŒä½¿ã†URLå½¢å¼)
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB}
      NODE_ENV: ${NODE_ENV}
      PORT: ${PORT}
    depends_on:
      - db
    restart: always
    # NestJSã®ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰èµ·å‹•ã‚³ãƒãƒ³ãƒ‰
    command: npm run start:dev
    # command: npm run start # ğŸš¨ èµ·å‹•ã‚³ãƒãƒ³ãƒ‰ã‚’Node.jsã«å¤‰æ›´ã€ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯

    # 2. MySQL / PostgreSQL ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚µãƒ¼ãƒ“ã‚¹ (PostgreSQLã¸ã®å¤‰æ›´ä¾‹)
  db:
    image: postgres:15-alpine
    container_name: keep-info-db
    ports:
      - "5432:5432" # ğŸš¨ PostgreSQLã®æ¨™æº–ãƒãƒ¼ãƒˆ
    volumes:
      - ./postgres/init.sql:/docker-entrypoint-initdb.d/init.sql # PostgreSQLåˆæœŸåŒ–ãƒ•ã‚¡ã‚¤ãƒ«
      - db-data:/var/lib/postgresql/data # ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–
    environment:
      # PostgreSQLæ¨™æº–ã®ç’°å¢ƒå¤‰æ•°ã‚’ä½¿ç”¨
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    restart: always

volumes:
  db-data:
